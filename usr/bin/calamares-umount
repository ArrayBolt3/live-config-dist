#!/bin/bash

if [ ! "$(id -u)" = "0" ]; then
  echo "$0: Must be run as root! (sudo)" >&2
  exit 1
fi

echo "$0: START"

reverse_proc_mounts=$(tac /proc/mounts)

while read -r line ; do
  if [ "$line" = "" ]; then
    continue
  fi
  b=$(echo "$line" | awk '{print $2}')
  c=$(echo "$b" | grep "/tmp")
  d=$(echo "$c" | grep "/calamares")
  if [ "$d" = "" ]; then
    continue
  fi
  echo umount "$d"
  umount "$d"
done <<< "$reverse_proc_mounts"

echo "$0: DONE"
